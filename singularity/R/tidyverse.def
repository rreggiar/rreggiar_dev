Bootstrap: docker
From: rocker/tidyverse:latest

%environment

  export LC_ALL=C
  export LIBSBML_CFLAGS="-I/usr/include"
  export LIBSBML_LIBS="-lsbml"
  export BIOCONDUCTOR_DOCKER_VERSION=$BIOCONDUCTOR_DOCKER_VERSION
  export BIOCONDUCTOR_VERSION=$BIOCONDUCTOR_VERSION

  USER=${USER:-'rreggiar'}

%files

  install_UTIL.sh /tmp/install_UTIL.sh 
  install.R /tmp/install.R
  install_PERL.sh /tmp/install_PERL.sh
  install_MEME.sh /tmp/install_MEME.sh


%post

  # nuke cache dirs before installing pkgs; tip from Dirk E fixes broken img
  rm -f /var/lib/dpkg/available && rm -rf  /var/cache/apt/*
  dpkg --clear-avail
  # https://github.com/geerlingguy/ansible-role-java/issues/64
  mkdir -p /usr/share/man/man1

  apt-get update \
  && apt-get install -y --no-install-recommends apt-utils \
	&& apt-get install -y --no-install-recommends \
	gdb \
	libxml2-dev \
	python3-pip \
	libz-dev \
	liblzma-dev \
	libbz2-dev \
	libpng-dev \
	libgit2-dev \
	pkg-config \
	fortran77-compiler \
	byacc \
	automake \
	curl \
	libpcre2-dev \
	libnetcdf-dev \
	libhdf5-serial-dev \
	libfftw3-dev \
	libopenbabel-dev \
	libopenmpi-dev \
	libxt-dev \
	libudunits2-dev \
	libgeos-dev \
	libproj-dev \
	libcairo2-dev \
	libtiff5-dev \
	libreadline-dev \
	libgsl0-dev \
	libgslcblas0 \
	libgtk2.0-dev \
	libgl1-mesa-dev \
	libglu1-mesa-dev \
	libgmp3-dev \
	libhdf5-dev \
	libncurses-dev \
	libbz2-dev \
	libxpm-dev \
	liblapack-dev \
	libv8-dev \
	libgtkmm-2.4-dev \
	libmpfr-dev \
	libmodule-build-perl \
	libapparmor-dev \
	libprotoc-dev \
	librdf0-dev \
	libmagick++-dev \
	libsasl2-dev \
	libpoppler-cpp-dev \
	libprotobuf-dev \
	libpq-dev \
	libperl-dev \
	libarchive-extract-perl \
	libfile-copy-recursive-perl \
	libcgi-pm-perl \
	libdbi-perl \
	libdbd-mysql-perl \
	libxml-simple-perl \
	libmysqlclient-dev \
	default-libmysqlclient-dev \
	libgdal-dev \
  libglpk-dev \
  libeigen3-dev \
	sqlite \
	openmpi-bin \
	mpi-default-bin \
	openmpi-common \
	openmpi-doc \
	tcl8.6-dev \
	tk-dev \
	default-jdk \
	imagemagick \
	tabix \
	ggobi \
	graphviz \
	protobuf-compiler \
	jags \
	xfonts-100dpi \
	xfonts-75dpi \
	biber \
  libsbml5-dev \
  libzmq3-dev \
  python3-dev \
	&& apt-get clean \
	&& rm -rf /var/lib/apt/lists/*
  apt install wget -y
  apt install curl -y
  apt install default-jre -y

  pip3 install scikit-learn \
        pandas \
        pyyaml

  apt-get update \
	&& apt-get -y --no-install-recommends install \
	libmariadb-dev-compat \
	libjpeg-dev \
	libjpeg-turbo8-dev \
	libjpeg8-dev \
	&& apt-get clean \
	&& rm -rf /var/lib/apt/lists/*

  echo "R_LIBS=/usr/local/lib/R/host-site-library:\${R_LIBS}" > /usr/local/lib/R/etc/Renviron.site
  . ./tmp/install_UTIL.sh
  R -f /tmp/install.R
  . ./tmp/install_PERL.sh
  . ./tmp/install_MEME.sh

  echo "MEME_PATH=/opt/meme-5.5.1/bin" >> /usr/local/lib/R/etc/Renviron.site
  echo "MEME_BIN=/opt/meme-5.5.1/bin" >> /usr/local/lib/R/etc/Renviron.site

  curl -O http://bioconductor.org/checkResults/devel/bioc-LATEST/Renviron.bioc \
	&& cat Renviron.bioc | grep -o '^[^#]*' | sed 's/export //g' >>/etc/environment \
	&& cat Renviron.bioc >> /usr/local/lib/R/etc/Renviron.site \
	&& echo BIOCONDUCTOR_VERSION=${BIOCONDUCTOR_VERSION} >> /usr/local/lib/R/etc/Renviron.site \
        && echo BIOCONDUCTOR_DOCKER_VERSION=${BIOCONDUCTOR_DOCKER_VERSION} >> /usr/local/lib/R/etc/Renviron.site \
        && echo 'LIBSBML_CFLAGS="-I/usr/include"' >> /usr/local/lib/R/etc/Renviron.site \
        && echo 'LIBSBML_LIBS="-lsbml"' >> /usr/local/lib/R/etc/Renviron.site \
	&& rm -rf Renviron.bioc

